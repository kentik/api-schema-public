syntax = "proto3";

package kentik.deviceconf.v202511;
option go_package = "github.com/kentik/api-schema-public/gen/go/kentik/deviceconf/v202511;deviceconf";

import "google/protobuf/timestamp.proto";

import "kentik/core/v202303/annotations.proto";

import "kentik/deviceconf/v202511/command.proto";
import "kentik/deviceconf/v202511/config.proto";
import "kentik/deviceconf/v202511/device.proto";
import "kentik/deviceconf/v202511/signature.proto";

service DeviceConfigurationService {
  option (kentik.core.v202303.visibility) = SERVICE_VISIBILITY_PUBLIC;
  option (kentik.core.v202303.service_scope) = "deviceconf:admin";

  // Get devices assigned to this agent.
  //
  // External clients MUST set the following gRPC metadata:
  // - x-ch-auth-email
  // - x-ch-auth-api-token
  // - x-kt-agentid
  // Note: x-kt-cid (Company ID) is automatically set by apigw based on auth headers.
  //
  // Internal clients MUST set the following gRPC metadata:
  // - x-kt-cid (Company ID)
  // - x-kt-agentid
  //
  rpc GetDeviceAssignments(GetDeviceAssignmentsRequest) returns (GetDeviceAssignmentsResponse) {
    option (kentik.core.v202303.method_scope) = "deviceconf:read";
  }

  // Update device configuration.
  //
  // External clients MUST set the following gRPC metadata:
  // - x-ch-auth-email
  // - x-ch-auth-api-token
  // - x-kt-agentid
  // - x-kt-did
  // Note: x-kt-cid (Company ID) is automatically set by apigw based on auth headers.
  //
  // Internal clients MUST set the following gRPC metadata:
  // - x-kt-cid (Company ID)
  // - x-kt-agentid
  // - x-kt-did
  //
  rpc UpdateDeviceConfiguration(UpdateDeviceConfigurationRequest) returns (UpdateDeviceConfigurationResponse) {
    option (kentik.core.v202303.method_scope) = "deviceconf:write";
  }

  // Get device configuration.
  //
  // External clients MUST set the following gRPC metadata:
  // - x-ch-auth-email
  // - x-ch-auth-api-token
  // Note: x-kt-cid (Company ID) is automatically set by apigw based on auth headers.
  //
  // Internal clients MUST set the following gRPC metadata:
  // - x-kt-cid (Company ID)
  //
  rpc GetDeviceConfiguration(GetDeviceConfigurationRequest) returns (GetDeviceConfigurationResponse) {
    option (kentik.core.v202303.method_scope) = "deviceconf:read";
  }

  // Get latest configuration for many devices
  //
  // External clients MUST set the following gRPC metadata:
  // - x-ch-auth-email
  // - x-ch-auth-api-token
  // Note: x-kt-cid (Company ID) is automatically set by apigw based on auth headers.
  //
  // Internal clients MUST set the following gRPC metadata:
  // - x-kt-cid (Company ID)
  //
  rpc GetLatestDeviceConfigurations(GetLatestDeviceConfigurationsRequest) returns (GetLatestDeviceConfigurationsResponse) {
    option (kentik.core.v202303.method_scope) = "deviceconf:read";
  }

  // List device configuration revisions
  //
  // External clients MUST set the following gRPC metadata:
  // - x-ch-auth-email
  // - x-ch-auth-api-token
  // Note: x-kt-cid (Company ID) is automatically set by apigw based on auth headers.
  //
  // Internal clients MUST set the following gRPC metadata:
  // - x-kt-cid (Company ID)
  //
  rpc ListDeviceConfigurationRevisions(ListDeviceConfigurationRevisionsRequest) returns (ListDeviceConfigurationRevisionsResponse) {
    option (kentik.core.v202303.method_scope) = "deviceconf:read";
  }

  // Request an immediate device configuration fetch.
  // The actual fetch will be performed asynchronously.
  //
  // External clients MUST set the following gRPC metadata:
  // - x-ch-auth-email
  // - x-ch-auth-api-token
  // Note: x-kt-cid (Company ID) is automatically set by apigw based on auth headers.
  //
  // Internal clients MUST set the following gRPC metadata:
  // - x-kt-cid (Company ID)
  //
  rpc RequestDeviceConfigurationFetch(RequestDeviceConfigurationFetchRequest) returns (RequestDeviceConfigurationFetchResponse) {
    option (kentik.core.v202303.method_scope) = "deviceconf:write";
  }

  // Request a device execute the given command. This will be performed synchronously.
  //
  // This is an INTERNAL API ONLY and is not exposed to external clients.
  // Callers must sign the request to prove that they are authorized to request command execution.
  //
  // Internal clients MUST set the following gRPC metadata:
  // - x-kt-cid (Company ID)
  // - x-kt-uid (User ID)
  //
  rpc ExecuteCommand(ExecuteCommandRequest) returns (ExecuteCommandResponse) {
    option (kentik.core.v202303.method_visibility) = METHOD_VISIBILITY_PRIVATE;
    option (kentik.core.v202303.method_scope) = "deviceconf:write";
  }

  // Get the current command ACLs for the given company.
  //
  // External clients MUST set the following gRPC metadata:
  // - x-ch-auth-email
  // - x-ch-auth-api-token
  // Note: x-kt-cid (Company ID) is automatically set by apigw based on auth headers.
  //
  // Internal clients MUST set the following gRPC metadata:
  // - x-kt-cid (Company ID; 0 will return global ACLs)
  //
  rpc GetCommandAcls(GetCommandAclsRequest) returns (GetCommandAclsResponse) {
    option (kentik.core.v202303.method_scope) = "deviceconf:read";
  }

  // Update the current command ACLs for the given company.
  // The entire ACL set is replaced with the given ACLs.
  //
  // External clients MUST set the following gRPC metadata:
  // - x-ch-auth-email
  // - x-ch-auth-api-token
  // Note: x-kt-cid (Company ID) is automatically set by apigw based on auth headers.
  //
  // Internal clients MUST set the following gRPC metadata:
  // - x-kt-cid (Company ID)
  //
  rpc UpdateCommandAcls(UpdateCommandAclsRequest) returns (UpdateCommandAclsResponse) {
    option (kentik.core.v202303.method_scope) = "deviceconf:write";
  }

  // Delete a specific device configuration revision.
  //
  // External clients MUST set the following gRPC metadata:
  // - x-ch-auth-email
  // - x-ch-auth-api-token
  // Note: x-kt-cid (Company ID) is automatically set by apigw based on auth headers.
  //
  // Internal clients MUST set the following gRPC metadata:
  // - x-kt-cid (Company ID)
  //
  rpc DeleteDeviceConfiguration(DeleteDeviceConfigurationRequest) returns (DeleteDeviceConfigurationResponse) {
    option (kentik.core.v202303.method_scope) = "deviceconf:write";
  }
}

message GetDeviceAssignmentsRequest {
  // Only company ID and agent ID from metadata are used.
}

message GetDeviceAssignmentsResponse {
  repeated Device devices = 1;
}

message UpdateDeviceConfigurationRequest {
  Snapshot config = 1;
}

message UpdateDeviceConfigurationResponse {

}

message GetDeviceConfigurationRequest {
  // If set, return the configuration closest to (but not after) this time.
  // If not set, return the latest configuration.
  google.protobuf.Timestamp fetch_time = 1;

  // If set, return the configuration with this revision ID.
  string revision = 2;

  // If set, compute the diff against the given revision ID.
  string ref_revision = 3;

  // Device ID to get configuration for. Required.
  string device_id = 4;

  // If true, do not include config_data in the response.
  // Useful for checking metadata without transferring large config data.
  bool exclude_config_data = 5;

  // If true, do not include diff_data in the response.
  bool exclude_diff_data = 6;
}

message GetDeviceConfigurationResponse {
  Snapshot config = 1;
}

message GetLatestDeviceConfigurationsRequest {
  // If set, only return configurations for these device IDs.
  // If not set, return configurations for all devices.
  repeated string device_ids = 1;

  // If true, do not include config_data in the response.
  // Useful for checking metadata without transferring large config data.
  bool exclude_config_data = 2;

  // If true, do not include diff_data in the response.
  bool exclude_diff_data = 3;
}

message GetLatestDeviceConfigurationsResponse {
  // Map from device ID to latest configuration.
  map<string, Snapshot> configs = 1;
}

// Fetch all device configuration revisions within the given time range.
message ListDeviceConfigurationRevisionsRequest {
  google.protobuf.Timestamp from_time  = 1;
  google.protobuf.Timestamp until_time = 2;
  // Maximum number of revisions to return. Default is to return all.
  // Revisions are returned in descending order (latest first).
  int32 limit = 3;
  // Device ID to list revisions for. If not set, list revisions for all devices.
  string device_id = 4;
}

message ListDeviceConfigurationRevisionsResponse {
  repeated Revision revisions = 1;
}

message RequestDeviceConfigurationFetchRequest {
  string device_id = 1;
}

message RequestDeviceConfigurationFetchResponse {

}

message ExecuteCommandRequest {
  DeviceCommand    device_command = 1;
  MessageSignature signature      = 2;
}

message ExecuteCommandResponse {
  CommandResult command_result = 1;
}

message GetCommandAclsRequest {
}

message GetCommandAclsResponse {
  repeated CommandAcl acls = 1;
}

message UpdateCommandAclsRequest {
  repeated CommandAcl acls = 1;
}

message UpdateCommandAclsResponse {
}

message DeleteDeviceConfigurationRequest {
  string device_id = 1;
  string revision  = 2;
}

message DeleteDeviceConfigurationResponse {
}
